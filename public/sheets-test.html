<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLink4u - Google Sheets Setup Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .loading { border-color: #2196F3; background: #f8f8ff; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #5a6fd8; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 300px;
        }
        .setup-guide {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß QLink4u - Google Sheets Setup Test</h1>
        <p>Test Google Sheets API integration</p>

        <div class="setup-guide">
            <h3>üìã Quick Setup Guide</h3>
            <div class="step">
                <strong>1. T·∫°o Google Sheets:</strong>
                <br>‚Ä¢ T·∫°o sheet m·ªõi t·∫°i <a href="https://sheets.google.com" target="_blank">sheets.google.com</a>
                <br>‚Ä¢ T·∫°o 2 tabs: "Users" v√† "Links"
                <br>‚Ä¢ Users headers: ID | Email | Full Name | Created At
                <br>‚Ä¢ Links headers: ID | Alias | URL | Title | Description | Type | Password | Expires | Max Clicks | Click Count | Created At | User Email
            </div>
            <div class="step">
                <strong>2. T·∫°o API Key:</strong>
                <br>‚Ä¢ V√†o <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a>
                <br>‚Ä¢ Enable "Google Sheets API"
                <br>‚Ä¢ T·∫°o API Key t·∫°i "Credentials"
                <br>‚Ä¢ Restrict key cho Google Sheets API
            </div>
            <div class="step">
                <strong>3. Chia s·∫ª Sheets:</strong>
                <br>‚Ä¢ Click "Share" ‚Üí "Anyone with the link" ‚Üí "Viewer"
                <br>‚Ä¢ Copy Spreadsheet ID t·ª´ URL
            </div>
        </div>

        <div class="test-section">
            <h3>üîë API Configuration</h3>
            <div>
                <label>Spreadsheet ID:</label><br>
                <input type="text" id="spreadsheetId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms">
            </div>
            <div>
                <label>API Key:</label><br>
                <input type="password" id="apiKey" placeholder="AIzaSyC4sjQn...">
            </div>
            <button onclick="saveConfig()">Save Configuration</button>
            <button onclick="loadConfig()">Load Saved Config</button>
            <div id="configResult"></div>
        </div>

        <div class="test-section">
            <h3>üîç Test API Connection</h3>
            <button onclick="testConnection()">Test Google Sheets API</button>
            <div id="connectionResult"></div>
        </div>

        <div class="test-section">
            <h3>üìä Test Read Data</h3>
            <button onclick="testReadUsers()">Read Users Sheet</button>
            <button onclick="testReadLinks()">Read Links Sheet</button>
            <div id="readResult"></div>
        </div>

        <div class="test-section">
            <h3>‚úçÔ∏è Test Write Data</h3>
            <div>
                <input type="email" id="testEmail" placeholder="test@example.com" value="test@qlink4u.com">
                <input type="text" id="testName" placeholder="Test User" value="Test User">
            </div>
            <button onclick="testWriteUser()">Write Test User</button>
            <div>
                <input type="text" id="testAlias" placeholder="test123" value="test123">
                <input type="url" id="testUrl" placeholder="https://google.com" value="https://google.com">
            </div>
            <button onclick="testWriteLink()">Write Test Link</button>
            <div id="writeResult"></div>
        </div>

        <div class="test-section">
            <h3>üìù Console Logs</h3>
            <button onclick="clearLogs()">Clear Logs</button>
            <pre id="consoleLogs"></pre>
        </div>
    </div>

    <script>
        let config = {
            spreadsheetId: '',
            apiKey: ''
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const logElement = document.getElementById('consoleLogs')
            const logLine = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`
            logElement.textContent += logLine
            logElement.scrollTop = logElement.scrollHeight
            
            if (type === 'error') {
                console.error(message)
            } else {
                console.log(message)
            }
        }

        function saveConfig() {
            const spreadsheetId = document.getElementById('spreadsheetId').value
            const apiKey = document.getElementById('apiKey').value
            
            if (!spreadsheetId || !apiKey) {
                document.getElementById('configResult').innerHTML = '<div class="error">Please enter both Spreadsheet ID and API Key</div>'
                return
            }
            
            config = { spreadsheetId, apiKey }
            localStorage.setItem('qlink4u_sheets_config', JSON.stringify(config))
            
            document.getElementById('configResult').innerHTML = '<div class="success">‚úÖ Configuration saved!</div>'
            log('Configuration saved successfully')
        }

        function loadConfig() {
            const saved = localStorage.getItem('qlink4u_sheets_config')
            if (saved) {
                config = JSON.parse(saved)
                document.getElementById('spreadsheetId').value = config.spreadsheetId
                document.getElementById('apiKey').value = config.apiKey
                document.getElementById('configResult').innerHTML = '<div class="success">‚úÖ Configuration loaded!</div>'
                log('Configuration loaded from localStorage')
            } else {
                document.getElementById('configResult').innerHTML = '<div class="error">‚ùå No saved configuration found</div>'
                log('No saved configuration found')
            }
        }

        async function testConnection() {
            if (!config.spreadsheetId || !config.apiKey) {
                document.getElementById('connectionResult').innerHTML = '<div class="error">‚ùå Please save configuration first</div>'
                return
            }

            document.getElementById('connectionResult').innerHTML = '<div class="loading">üîÑ Testing connection...</div>'
            log('Testing Google Sheets API connection...')

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}?key=${config.apiKey}`
                )

                log(`API Response status: ${response.status}`)

                if (!response.ok) {
                    const errorText = await response.text()
                    log(`API Error: ${errorText}`, 'error')
                    throw new Error(`HTTP ${response.status}: ${errorText}`)
                }

                const data = await response.json()
                log(`Spreadsheet title: ${data.properties.title}`)
                log(`Sheets count: ${data.sheets.length}`)

                const sheetNames = data.sheets.map(sheet => sheet.properties.title)
                log(`Sheet names: ${sheetNames.join(', ')}`)

                document.getElementById('connectionResult').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Connection Successful!</h4>
                        <p><strong>Spreadsheet:</strong> ${data.properties.title}</p>
                        <p><strong>Sheets:</strong> ${sheetNames.join(', ')}</p>
                        <p><strong>Required sheets:</strong> ${sheetNames.includes('Users') ? '‚úÖ' : '‚ùå'} Users, ${sheetNames.includes('Links') ? '‚úÖ' : '‚ùå'} Links</p>
                    </div>
                `

            } catch (error) {
                log(`Connection test failed: ${error.message}`, 'error')
                document.getElementById('connectionResult').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Connection Failed:</h4>
                        <pre>${error.message}</pre>
                        <p><strong>Common issues:</strong></p>
                        <ul>
                            <li>Invalid API Key</li>
                            <li>Google Sheets API not enabled</li>
                            <li>Spreadsheet not shared publicly</li>
                            <li>Wrong Spreadsheet ID</li>
                        </ul>
                    </div>
                `
            }
        }

        async function testReadUsers() {
            if (!config.spreadsheetId || !config.apiKey) {
                document.getElementById('readResult').innerHTML = '<div class="error">‚ùå Please save configuration first</div>'
                return
            }

            document.getElementById('readResult').innerHTML = '<div class="loading">üîÑ Reading Users sheet...</div>'
            log('Reading Users sheet...')

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}/values/Users!A:D?key=${config.apiKey}`
                )

                if (!response.ok) {
                    const errorText = await response.text()
                    throw new Error(`HTTP ${response.status}: ${errorText}`)
                }

                const data = await response.json()
                const rows = data.values || []
                
                log(`Users sheet rows: ${rows.length}`)
                
                document.getElementById('readResult').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Users Sheet Read Successfully!</h4>
                        <p><strong>Rows:</strong> ${rows.length}</p>
                        <pre>${JSON.stringify(rows, null, 2)}</pre>
                    </div>
                `

            } catch (error) {
                log(`Read Users failed: ${error.message}`, 'error')
                document.getElementById('readResult').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Read Users Failed:</h4>
                        <pre>${error.message}</pre>
                    </div>
                `
            }
        }

        async function testReadLinks() {
            if (!config.spreadsheetId || !config.apiKey) {
                document.getElementById('readResult').innerHTML = '<div class="error">‚ùå Please save configuration first</div>'
                return
            }

            document.getElementById('readResult').innerHTML = '<div class="loading">üîÑ Reading Links sheet...</div>'
            log('Reading Links sheet...')

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}/values/Links!A:L?key=${config.apiKey}`
                )

                if (!response.ok) {
                    const errorText = await response.text()
                    throw new Error(`HTTP ${response.status}: ${errorText}`)
                }

                const data = await response.json()
                const rows = data.values || []
                
                log(`Links sheet rows: ${rows.length}`)
                
                document.getElementById('readResult').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Links Sheet Read Successfully!</h4>
                        <p><strong>Rows:</strong> ${rows.length}</p>
                        <pre>${JSON.stringify(rows, null, 2)}</pre>
                    </div>
                `

            } catch (error) {
                log(`Read Links failed: ${error.message}`, 'error')
                document.getElementById('readResult').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Read Links Failed:</h4>
                        <pre>${error.message}</pre>
                    </div>
                `
            }
        }

        async function testWriteUser() {
            if (!config.spreadsheetId || !config.apiKey) {
                document.getElementById('writeResult').innerHTML = '<div class="error">‚ùå Please save configuration first</div>'
                return
            }

            const email = document.getElementById('testEmail').value
            const name = document.getElementById('testName').value

            if (!email || !name) {
                document.getElementById('writeResult').innerHTML = '<div class="error">‚ùå Please enter email and name</div>'
                return
            }

            document.getElementById('writeResult').innerHTML = '<div class="loading">üîÑ Writing test user...</div>'
            log(`Writing test user: ${email}`)

            try {
                const userData = [
                    Date.now().toString(),
                    email,
                    name,
                    new Date().toISOString()
                ]

                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}/values/Users!A:D:append?valueInputOption=RAW&key=${config.apiKey}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            values: [userData]
                        })
                    }
                )

                if (!response.ok) {
                    const errorText = await response.text()
                    throw new Error(`HTTP ${response.status}: ${errorText}`)
                }

                const result = await response.json()
                log(`User written successfully: ${result.updates.updatedRows} rows`)

                document.getElementById('writeResult').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ User Written Successfully!</h4>
                        <p><strong>Updated rows:</strong> ${result.updates.updatedRows}</p>
                        <p><strong>Range:</strong> ${result.updates.updatedRange}</p>
                    </div>
                `

            } catch (error) {
                log(`Write User failed: ${error.message}`, 'error')
                document.getElementById('writeResult').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Write User Failed:</h4>
                        <pre>${error.message}</pre>
                    </div>
                `
            }
        }

        async function testWriteLink() {
            if (!config.spreadsheetId || !config.apiKey) {
                document.getElementById('writeResult').innerHTML = '<div class="error">‚ùå Please save configuration first</div>'
                return
            }

            const alias = document.getElementById('testAlias').value
            const url = document.getElementById('testUrl').value

            if (!alias || !url) {
                document.getElementById('writeResult').innerHTML = '<div class="error">‚ùå Please enter alias and URL</div>'
                return
            }

            document.getElementById('writeResult').innerHTML = '<div class="loading">üîÑ Writing test link...</div>'
            log(`Writing test link: ${alias} -> ${url}`)

            try {
                const linkData = [
                    Date.now().toString(),
                    alias,
                    url,
                    'Test Link',
                    'Test Description',
                    'redirect',
                    '',
                    '',
                    '',
                    '0',
                    new Date().toISOString(),
                    'test@qlink4u.com'
                ]

                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}/values/Links!A:L:append?valueInputOption=RAW&key=${config.apiKey}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            values: [linkData]
                        })
                    }
                )

                if (!response.ok) {
                    const errorText = await response.text()
                    throw new Error(`HTTP ${response.status}: ${errorText}`)
                }

                const result = await response.json()
                log(`Link written successfully: ${result.updates.updatedRows} rows`)

                document.getElementById('writeResult').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Link Written Successfully!</h4>
                        <p><strong>Updated rows:</strong> ${result.updates.updatedRows}</p>
                        <p><strong>Range:</strong> ${result.updates.updatedRange}</p>
                        <p><strong>Short URL:</strong> qlink4u.com/${alias}</p>
                    </div>
                `

            } catch (error) {
                log(`Write Link failed: ${error.message}`, 'error')
                document.getElementById('writeResult').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Write Link Failed:</h4>
                        <pre>${error.message}</pre>
                    </div>
                `
            }
        }

        function clearLogs() {
            document.getElementById('consoleLogs').textContent = ''
        }

        // Auto-load config on page load
        window.addEventListener('load', function() {
            log('Google Sheets test page loaded')
            loadConfig()
        })
    </script>
</body>
</html>