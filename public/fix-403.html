<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLink4u - Fix Google Sheets 403 Error</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error-box {
            background: #ffebee;
            border: 1px solid #f44336;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .success-box {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .warning-box {
            background: #fff3e0;
            border: 1px solid #ff9800;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .step {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
            border-radius: 0 5px 5px 0;
        }
        .step h3 {
            margin-top: 0;
            color: #667eea;
        }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            border: 1px solid #ddd;
            overflow-x: auto;
        }
        .highlight {
            background: yellow;
            padding: 2px 4px;
            border-radius: 2px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #5a6fd8; }
        .checklist {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .checklist input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .checklist label {
            display: block;
            margin: 10px 0;
            cursor: pointer;
        }
        img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Google Sheets 403 Error</h1>
        
        <div class="error-box">
            <h3>‚ùå L·ªói ph·ªï bi·∫øn:</h3>
            <div class="code">
HTTP 403: "The caller does not have permission"
HTTP 401: "Request had invalid authentication credentials"</div>
        </div>

        <div class="warning-box">
            <h3>‚ö†Ô∏è Nguy√™n nh√¢n ch√≠nh:</h3>
            <ul>
                <li><strong>401 Unauthorized:</strong> API Key kh√¥ng h·ª£p l·ªá, ƒë√£ h·∫øt h·∫°n, ho·∫∑c b·ªã v√¥ hi·ªáu h√≥a</li>
                <li><strong>403 Forbidden:</strong> Google Sheets ch∆∞a ƒë∆∞·ª£c chia s·∫ª c√¥ng khai</li>
                <li><strong>API Key restrictions:</strong> API Key b·ªã restrict qu√° ch·∫∑t</li>
                <li><strong>Google Sheets API:</strong> Ch∆∞a ƒë∆∞·ª£c enable trong Google Cloud</li>
            </ul>
        </div>

        <h2>üõ†Ô∏è H∆∞·ªõng d·∫´n fix t·ª´ng b∆∞·ªõc</h2>

        <div class="step">
            <h3>B∆∞·ªõc 1: Ki·ªÉm tra Google Sheets Sharing</h3>
            <p><strong>ƒê√¢y l√† nguy√™n nh√¢n ph·ªï bi·∫øn nh·∫•t!</strong></p>
            <ol>
                <li>M·ªü Google Sheets c·ªßa b·∫°n</li>
                <li>Click n√∫t <strong>"Share"</strong> (g√≥c tr√™n b√™n ph·∫£i)</li>
                <li>Click <strong>"Change to anyone with the link"</strong></li>
                <li>Ch·ªçn <strong>"Viewer"</strong> (kh√¥ng ph·∫£i Editor)</li>
                <li>Click <strong>"Done"</strong></li>
            </ol>
            <div class="warning-box">
                <strong>Quan tr·ªçng:</strong> Sheets ph·∫£i ƒë∆∞·ª£c set th√†nh <span class="highlight">"Anyone with the link can view"</span>
            </div>
        </div>

        <div class="step">
            <h3>B∆∞·ªõc 2: Ki·ªÉm tra Google Cloud Console</h3>
            <ol>
                <li>V√†o <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                <li>Ch·ªçn project c·ªßa b·∫°n</li>
                <li>V√†o <strong>"APIs & Services" ‚Üí "Library"</strong></li>
                <li>T√¨m <strong>"Google Sheets API"</strong></li>
                <li>ƒê·∫£m b·∫£o n√≥ ƒë√£ <strong>"Enabled"</strong></li>
            </ol>
        </div>

        <div class="step">
            <h3>B∆∞·ªõc 3: T·∫°o API Key m·ªõi (Recommended)</h3>
            <ol>
                <li>V√†o <strong>"APIs & Services" ‚Üí "Credentials"</strong></li>
                <li>Click <strong>"Create Credentials" ‚Üí "API Key"</strong></li>
                <li>Copy API Key m·ªõi</li>
                <li><strong>Quan tr·ªçng:</strong> Click v√†o API Key ƒë·ªÉ c·∫•u h√¨nh restrictions</li>
            </ol>
        </div>

        <div class="step">
            <h3>B∆∞·ªõc 4: C·∫•u h√¨nh API Key Restrictions</h3>
            <div class="warning-box">
                <strong>Ch·ªçn 1 trong 2 c√°ch:</strong>
            </div>
            
            <h4>C√°ch 1: Kh√¥ng restrict (D·ªÖ nh·∫•t - cho testing)</h4>
            <ul>
                <li><strong>Application restrictions:</strong> None</li>
                <li><strong>API restrictions:</strong> Don't restrict key</li>
            </ul>
            
            <h4>C√°ch 2: Restrict an to√†n (Cho production)</h4>
            <ul>
                <li><strong>Application restrictions:</strong> HTTP referrers</li>
                <li>Th√™m domains: <code>*.skywork.website/*</code>, <code>qlink4u.com/*</code>, <code>localhost/*</code></li>
                <li><strong>API restrictions:</strong> Restrict key</li>
                <li>Ch·ªçn: <strong>Google Sheets API</strong></li>
            </ul>
        </div>

        <div class="step">
            <h3>B∆∞·ªõc 5: Test v·ªõi API Key m·ªõi</h3>
            <div>
                <label>New API Key:</label><br>
                <input type="password" id="newApiKey" placeholder="AIzaSyC4sjQn..." style="width: 400px; padding: 8px; margin: 5px;">
            </div>
            <div>
                <label>Spreadsheet ID:</label><br>
                <input type="text" id="testSpreadsheetId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms" style="width: 400px; padding: 8px; margin: 5px;">
            </div>
            <button onclick="testNewApiKey()">Test API Key m·ªõi</button>
            <div id="testResult"></div>
        </div>

        <div class="step">
            <h3>B∆∞·ªõc 6: T·∫°o Google Sheets m·∫´u</h3>
            <p>N·∫øu v·∫´n l·ªói, h√£y t·∫°o Sheets m·ªõi t·ª´ template:</p>
            <button onclick="createSampleSheet()">T·∫°o Google Sheets m·∫´u</button>
            <div class="code">
Template URL: <a href="https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/copy" target="_blank">
https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/copy
</a></div>
        </div>

        <div class="checklist">
            <h3>‚úÖ Checklist ho√†n th√†nh:</h3>
            <label><input type="checkbox"> Google Sheets ƒë√£ share "Anyone with the link can view"</label>
            <label><input type="checkbox"> Google Sheets API ƒë√£ enabled trong Cloud Console</label>
            <label><input type="checkbox"> API Key m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o</label>
            <label><input type="checkbox"> API Key restrictions ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh</label>
            <label><input type="checkbox"> Sheets c√≥ 2 tabs: "Users" v√† "Links"</label>
            <label><input type="checkbox"> Headers ƒë√£ ƒë∆∞·ª£c setup ƒë√∫ng</label>
            <label><input type="checkbox"> Test API Key th√†nh c√¥ng</label>
        </div>

        <div class="success-box">
            <h3>üéØ Sau khi fix:</h3>
            <ol>
                <li>V√†o <a href="/" target="_blank">QLink4u homepage</a></li>
                <li>Click "C·∫•u h√¨nh Google Sheets"</li>
                <li>Nh·∫≠p API Key v√† Spreadsheet ID m·ªõi</li>
                <li>Test t·∫°o link</li>
            </ol>
        </div>

        <h2>üîç Troubleshooting th√™m</h2>

        <div class="step">
            <h3>N·∫øu v·∫´n l·ªói 403:</h3>
            <ol>
                <li><strong>ƒê·ª£i 5-10 ph√∫t:</strong> Google API c·∫ßn th·ªùi gian propagate</li>
                <li><strong>Clear browser cache:</strong> Ctrl+F5 ho·∫∑c hard refresh</li>
                <li><strong>Try incognito mode:</strong> Test trong c·ª≠a s·ªï ·∫©n danh</li>
                <li><strong>Check quota:</strong> Google Sheets API c√≥ limits</li>
                <li><strong>T·∫°o project m·ªõi:</strong> Trong Google Cloud Console</li>
            </ol>
        </div>

        <div class="step">
            <h3>Alternative: S·ª≠ d·ª•ng Service Account (Advanced)</h3>
            <p>N·∫øu API Key kh√¥ng ho·∫°t ƒë·ªông, c√≥ th·ªÉ d√πng Service Account:</p>
            <ol>
                <li>T·∫°o Service Account trong Google Cloud Console</li>
                <li>Download JSON key file</li>
                <li>Share Google Sheets v·ªõi Service Account email</li>
                <li>S·ª≠ d·ª•ng OAuth2 thay v√¨ API Key</li>
            </ol>
            <div class="warning-box">
                <strong>L∆∞u √Ω:</strong> Service Account ph·ª©c t·∫°p h∆°n, ch·ªâ d√πng khi API Key kh√¥ng ho·∫°t ƒë·ªông
            </div>
        </div>

        <div class="step">
            <h3>üÜò N·∫øu v·∫´n kh√¥ng ƒë∆∞·ª£c:</h3>
            <p>H√£y th·ª≠ c√°c b∆∞·ªõc sau:</p>
            <ol>
                <li><strong>T·∫°o Google Account m·ªõi</strong> ƒë·ªÉ test</li>
                <li><strong>T·∫°o Google Cloud Project m·ªõi</strong></li>
                <li><strong>S·ª≠ d·ª•ng template Sheets</strong> thay v√¨ t·ª± t·∫°o</li>
                <li><strong>Test v·ªõi domain kh√°c</strong> (kh√¥ng ph·∫£i localhost)</li>
            </ol>
        </div>
    </div>

    <script>
        async function testNewApiKey() {
            const apiKey = document.getElementById('newApiKey').value
            const spreadsheetId = document.getElementById('testSpreadsheetId').value
            const resultDiv = document.getElementById('testResult')
            
            if (!apiKey || !spreadsheetId) {
                resultDiv.innerHTML = '<div style="color: red;">‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß API Key v√† Spreadsheet ID</div>'
                return
            }
            
            resultDiv.innerHTML = '<div style="color: blue;">üîÑ ƒêang test API Key...</div>'
            
            try {
                // Test basic spreadsheet access
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${apiKey}`
                )
                
                console.log('API Response status:', response.status)
                
                if (response.status === 403) {
                    const errorData = await response.json()
                    resultDiv.innerHTML = `
                        <div style="color: red;">
                            <h4>‚ùå V·∫´n l·ªói 403!</h4>
                            <p><strong>Chi ti·∫øt:</strong> ${JSON.stringify(errorData, null, 2)}</p>
                            <p><strong>Kh·∫£ nƒÉng cao:</strong></p>
                            <ul>
                                <li>Google Sheets ch∆∞a ƒë∆∞·ª£c share c√¥ng khai</li>
                                <li>API Key restrictions qu√° ch·∫∑t</li>
                                <li>C·∫ßn ƒë·ª£i 5-10 ph√∫t ƒë·ªÉ Google propagate</li>
                            </ul>
                        </div>
                    `
                    return
                }
                
                if (!response.ok) {
                    const errorText = await response.text()
                    resultDiv.innerHTML = `
                        <div style="color: red;">
                            <h4>‚ùå L·ªói ${response.status}:</h4>
                            <pre>${errorText}</pre>
                        </div>
                    `
                    return
                }
                
                const data = await response.json()
                
                // Test reading values
                const valuesResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Users!A:D?key=${apiKey}`
                )
                
                if (valuesResponse.ok) {
                    const valuesData = await valuesResponse.json()
                    resultDiv.innerHTML = `
                        <div style="color: green;">
                            <h4>‚úÖ API Key ho·∫°t ƒë·ªông!</h4>
                            <p><strong>Spreadsheet:</strong> ${data.properties.title}</p>
                            <p><strong>Sheets:</strong> ${data.sheets.map(s => s.properties.title).join(', ')}</p>
                            <p><strong>Users rows:</strong> ${(valuesData.values || []).length}</p>
                            <p><strong>B∆∞·ªõc ti·∫øp theo:</strong> S·ª≠ d·ª•ng API Key n√†y trong QLink4u</p>
                        </div>
                    `
                    
                    // Save working config
                    const config = { spreadsheetId, apiKey }
                    localStorage.setItem('qlink4u_sheets_config', JSON.stringify(config))
                    
                } else {
                    resultDiv.innerHTML = `
                        <div style="color: orange;">
                            <h4>‚ö†Ô∏è API Key OK nh∆∞ng kh√¥ng ƒë·ªçc ƒë∆∞·ª£c data</h4>
                            <p>Spreadsheet accessible nh∆∞ng c√≥ th·ªÉ thi·∫øu sheets "Users" ho·∫∑c "Links"</p>
                            <p><strong>Spreadsheet:</strong> ${data.properties.title}</p>
                        </div>
                    `
                }
                
            } catch (error) {
                console.error('Test error:', error)
                resultDiv.innerHTML = `
                    <div style="color: red;">
                        <h4>‚ùå Network Error:</h4>
                        <p>${error.message}</p>
                        <p>C√≥ th·ªÉ do CORS ho·∫∑c network issue</p>
                    </div>
                `
            }
        }
        
        function createSampleSheet() {
            const templateUrl = 'https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/copy'
            window.open(templateUrl, '_blank')
            
            alert(`
Sau khi t·∫°o Sheets m·ªõi:
1. Copy Spreadsheet ID t·ª´ URL
2. Share "Anyone with the link can view"  
3. Paste ID v√†o form tr√™n
4. Test API Key
            `)
        }
        
        // Auto-load saved config
        window.addEventListener('load', function() {
            const saved = localStorage.getItem('qlink4u_sheets_config')
            if (saved) {
                const config = JSON.parse(saved)
                document.getElementById('testSpreadsheetId').value = config.spreadsheetId
                document.getElementById('newApiKey').value = config.apiKey
            }
        })
    </script>
</body>
</html>