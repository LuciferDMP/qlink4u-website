<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLink4u - Redirect</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
            max-width: 500px;
        }
        .loading {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }
        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .password-form {
            display: none;
            margin-top: 1rem;
        }
        .password-input {
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            margin-right: 0.5rem;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        .alias-display {
            font-family: monospace;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <div class="loading" id="loading-text">Đang kiểm tra link...</div>
        <div class="alias-display" id="alias-display" style="display: none;"></div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="password-form" class="password-form">
            <p>Link này được bảo vệ bằng mật khẩu:</p>
            <input type="password" id="password-input" class="password-input" placeholder="Nhập mật khẩu">
            <button onclick="submitPassword()" class="btn">Truy cập</button>
        </div>
        
        <div>
            <a href="/" class="btn">Quay về trang chủ</a>
            <a href="/dashboard" class="btn">Dashboard</a>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://vnmdlqgibiemwgfduzvv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZubWRscWdpYmllbXdnZmR1enZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NDczMjYsImV4cCI6MjA3NjQyMzMyNn0.wxkjuFMQ6T2oSSDtFrSt5BMay1TRqmVzSeFVosvHRKk';

        // Get alias from URL parameter or current path
        function getAlias() {
            const urlParams = new URLSearchParams(window.location.search);
            const aliasParam = urlParams.get('alias');
            if (aliasParam) return aliasParam;
            
            // Try to get from path (for direct access like /EPProject)
            const path = window.location.pathname;
            if (path && path !== '/') {
                return path.substring(1); // Remove leading slash
            }
            
            return null;
        }

        // Show error message
        function showError(message) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('loading-text').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = message;
        }

        // Show password form
        function showPasswordForm(alias) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('loading-text').style.display = 'none';
            document.getElementById('alias-display').style.display = 'block';
            document.getElementById('alias-display').textContent = `qlink4u.com/${alias}`;
            document.getElementById('password-form').style.display = 'block';
        }

        // Submit password
        async function submitPassword() {
            const password = document.getElementById('password-input').value;
            if (!password) {
                alert('Vui lòng nhập mật khẩu');
                return;
            }
            
            const alias = getAlias();
            await handleRedirect(alias, password);
        }

        // Handle redirect logic
        async function handleRedirect(alias, password = null) {
            if (!alias) {
                showError('Không tìm thấy alias trong URL');
                return;
            }

            try {
                // Fetch link data from Supabase
                const response = await fetch(`${SUPABASE_URL}/rest/v1/links_2025_10_23_12_04?alias=eq.${alias}&is_active=eq.true&select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Không thể kết nối đến server');
                }

                const data = await response.json();
                
                if (!data || data.length === 0) {
                    showError('Link không tồn tại hoặc đã bị vô hiệu hóa');
                    return;
                }

                const link = data[0];

                // Check if link has expired
                if (link.expires_at && new Date(link.expires_at) < new Date()) {
                    showError('Link đã hết hạn');
                    return;
                }

                // Check click limit
                if (link.max_clicks && link.current_clicks >= link.max_clicks) {
                    showError('Link đã đạt giới hạn số lần truy cập');
                    return;
                }

                // Check password
                if (link.password_hash && !password) {
                    showPasswordForm(alias);
                    return;
                }

                if (link.password_hash && password !== link.password_hash) {
                    showError('Mật khẩu không đúng');
                    return;
                }

                // Record click (simplified - just increment counter)
                try {
                    await fetch(`${SUPABASE_URL}/rest/v1/clicks_2025_10_23_12_04`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            link_id: link.id,
                            ip_address: '127.0.0.1',
                            user_agent: navigator.userAgent,
                            referrer: document.referrer,
                            device_type: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'mobile' : 'desktop',
                            browser: getBrowserName(),
                            os: getOSName()
                        })
                    });
                } catch (error) {
                    console.error('Error recording click:', error);
                }

                // Handle redirect based on link type
                if (link.link_type === 'masking') {
                    // Create masking page
                    document.body.innerHTML = `
                        <style>
                            body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
                            iframe { width: 100%; height: 100%; border: none; }
                            .loading { display: flex; align-items: center; justify-content: center; height: 100vh; background: #f5f5f5; color: #666; }
                        </style>
                        <div class="loading" id="loading">Đang tải...</div>
                        <iframe src="${link.destination_url}" onload="document.getElementById('loading').style.display='none'"></iframe>
                    `;
                } else {
                    // Regular redirect
                    document.getElementById('loading-text').textContent = `Đang chuyển hướng đến ${link.title || 'trang đích'}...`;
                    setTimeout(() => {
                        window.location.href = link.destination_url;
                    }, 1500);
                }

            } catch (error) {
                showError('Đã xảy ra lỗi: ' + error.message);
            }
        }

        // Helper functions
        function getBrowserName() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes('chrome') && !ua.includes('edg')) return 'chrome';
            if (ua.includes('firefox')) return 'firefox';
            if (ua.includes('safari') && !ua.includes('chrome')) return 'safari';
            if (ua.includes('edg')) return 'edge';
            return 'unknown';
        }

        function getOSName() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes('windows')) return 'windows';
            if (ua.includes('mac')) return 'macos';
            if (ua.includes('linux')) return 'linux';
            if (ua.includes('android')) return 'android';
            if (ua.includes('ios') || ua.includes('iphone') || ua.includes('ipad')) return 'ios';
            return 'unknown';
        }

        // Handle Enter key in password input
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('password-input');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        submitPassword();
                    }
                });
            }
        });

        // Start the redirect process
        const alias = getAlias();
        if (alias) {
            handleRedirect(alias);
        } else {
            showError('Không tìm thấy alias trong URL. Sử dụng: /go.html?alias=your-alias');
        }
    </script>
</body>
</html>