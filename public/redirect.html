<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLink4u - Redirecting...</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        a {
            color: white;
            text-decoration: underline;
        }
        .countdown {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">Q4U</div>
        <h1>QLink4u</h1>
        <div class="spinner"></div>
        <p id="status">ƒêang t√¨m ki·∫øm link...</p>
        <div id="result"></div>
        <div id="countdown" class="countdown" style="display: none;"></div>
    </div>

    <script>
        // Get alias from URL path
        const path = window.location.pathname
        const alias = path.substring(1) // Remove leading slash
        
        console.log('Redirect handler loaded for alias:', alias)
        
        // Google Sheets configuration
        let config = null
        
        // Load configuration
        function loadConfig() {
            const saved = localStorage.getItem('qlink4u_sheets_config')
            if (saved) {
                config = JSON.parse(saved)
                return true
            }
            return false
        }
        
        // Search for link in Google Sheets
        async function findLink(alias) {
            if (!config) {
                throw new Error('Google Sheets not configured')
            }
            
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}/values/Links!A:L?key=${config.apiKey}`
                )
                
                if (!response.ok) {
                    throw new Error(`Google Sheets API error: ${response.status}`)
                }
                
                const data = await response.json()
                const rows = data.values || []
                
                // Skip header row and find matching alias
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i]
                    if (row[1] === alias) { // Column B is alias
                        return {
                            id: row[0],
                            alias: row[1],
                            destination_url: row[2],
                            title: row[3],
                            description: row[4],
                            link_type: row[5] || 'redirect',
                            password_hash: row[6],
                            expires_at: row[7],
                            max_clicks: row[8] ? parseInt(row[8]) : null,
                            click_count: parseInt(row[9]) || 0,
                            created_at: row[10],
                            user_email: row[11]
                        }
                    }
                }
                
                return null // Link not found
                
            } catch (error) {
                console.error('Error finding link:', error)
                throw error
            }
        }
        
        // Update click count in Google Sheets
        async function updateClickCount(alias, currentCount) {
            // This would require more complex Google Sheets API calls
            // For now, we'll just log it
            console.log(`Would update click count for ${alias}: ${currentCount + 1}`)
        }
        
        // Check if link is expired
        function isExpired(expiresAt) {
            if (!expiresAt) return false
            return new Date(expiresAt) < new Date()
        }
        
        // Check if max clicks reached
        function isMaxClicksReached(clickCount, maxClicks) {
            if (!maxClicks) return false
            return clickCount >= maxClicks
        }
        
        // Redirect with countdown
        function redirectWithCountdown(url, seconds = 3) {
            const countdownEl = document.getElementById('countdown')
            const statusEl = document.getElementById('status')
            
            countdownEl.style.display = 'block'
            statusEl.textContent = `ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn: ${url}`
            
            let remaining = seconds
            countdownEl.textContent = remaining
            
            const interval = setInterval(() => {
                remaining--
                countdownEl.textContent = remaining
                
                if (remaining <= 0) {
                    clearInterval(interval)
                    window.location.href = url
                }
            }, 1000)
        }
        
        // Main redirect logic
        async function handleRedirect() {
            const statusEl = document.getElementById('status')
            const resultEl = document.getElementById('result')
            
            if (!alias) {
                statusEl.textContent = 'Kh√¥ng t√¨m th·∫•y alias'
                resultEl.innerHTML = `
                    <div class="error">
                        <h3>‚ùå L·ªói</h3>
                        <p>URL kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i link.</p>
                        <p><a href="/">‚Üê V·ªÅ trang ch·ªß QLink4u</a></p>
                    </div>
                `
                return
            }
            
            // Check if Google Sheets is configured
            if (!loadConfig()) {
                statusEl.textContent = 'Ch∆∞a c·∫•u h√¨nh Google Sheets'
                resultEl.innerHTML = `
                    <div class="error">
                        <h3>‚öôÔ∏è Ch∆∞a c·∫•u h√¨nh</h3>
                        <p>Google Sheets ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh.</p>
                        <p><a href="/">‚Üê C·∫•u h√¨nh t·∫°i trang ch·ªß</a></p>
                    </div>
                `
                return
            }
            
            try {
                statusEl.textContent = `ƒêang t√¨m ki·∫øm: ${alias}`
                
                const link = await findLink(alias)
                
                if (!link) {
                    statusEl.textContent = 'Kh√¥ng t√¨m th·∫•y link'
                    resultEl.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Link kh√¥ng t·ªìn t·∫°i</h3>
                            <p>Link <strong>${alias}</strong> kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a.</p>
                            <p><a href="/">‚Üê T·∫°o link m·ªõi t·∫°i QLink4u</a></p>
                        </div>
                    `
                    return
                }
                
                // Check if expired
                if (isExpired(link.expires_at)) {
                    statusEl.textContent = 'Link ƒë√£ h·∫øt h·∫°n'
                    resultEl.innerHTML = `
                        <div class="error">
                            <h3>‚è∞ Link ƒë√£ h·∫øt h·∫°n</h3>
                            <p>Link n√†y ƒë√£ h·∫øt h·∫°n v√†o ${new Date(link.expires_at).toLocaleString('vi-VN')}</p>
                            <p><a href="/">‚Üê T·∫°o link m·ªõi t·∫°i QLink4u</a></p>
                        </div>
                    `
                    return
                }
                
                // Check if max clicks reached
                if (isMaxClicksReached(link.click_count, link.max_clicks)) {
                    statusEl.textContent = 'Link ƒë√£ ƒë·∫°t gi·ªõi h·∫°n click'
                    resultEl.innerHTML = `
                        <div class="error">
                            <h3>üö´ ƒê√£ ƒë·∫°t gi·ªõi h·∫°n</h3>
                            <p>Link n√†y ƒë√£ ƒë·∫°t gi·ªõi h·∫°n ${link.max_clicks} l∆∞·ª£t click.</p>
                            <p><a href="/">‚Üê T·∫°o link m·ªõi t·∫°i QLink4u</a></p>
                        </div>
                    `
                    return
                }
                
                // Check if password protected
                if (link.password_hash) {
                    const password = prompt('Link n√†y ƒë∆∞·ª£c b·∫£o v·ªá b·∫±ng m·∫≠t kh·∫©u:')
                    if (password !== link.password_hash) {
                        statusEl.textContent = 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng'
                        resultEl.innerHTML = `
                            <div class="error">
                                <h3>üîí M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng</h3>
                                <p>Vui l√≤ng nh·∫≠p ƒë√∫ng m·∫≠t kh·∫©u ƒë·ªÉ truy c·∫≠p link.</p>
                                <p><a href="javascript:location.reload()">‚Üê Th·ª≠ l·∫°i</a></p>
                            </div>
                        `
                        return
                    }
                }
                
                // Update click count (would need more complex implementation)
                await updateClickCount(link.alias, link.click_count)
                
                // Success - redirect
                resultEl.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ T√¨m th·∫•y link!</h3>
                        <p><strong>Ti√™u ƒë·ªÅ:</strong> ${link.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ'}</p>
                        <p><strong>M√¥ t·∫£:</strong> ${link.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                        <p><strong>ƒê√≠ch ƒë·∫øn:</strong> ${link.destination_url}</p>
                        <p><strong>Lo·∫°i:</strong> ${link.link_type === 'masking' ? 'Link masking' : 'Redirect'}</p>
                    </div>
                `
                
                // Redirect based on link type
                if (link.link_type === 'masking') {
                    // For masking, we would need to load the content in an iframe
                    // For now, just redirect normally
                    redirectWithCountdown(link.destination_url, 3)
                } else {
                    // Normal redirect
                    redirectWithCountdown(link.destination_url, 3)
                }
                
            } catch (error) {
                console.error('Redirect error:', error)
                statusEl.textContent = 'L·ªói khi t√¨m ki·∫øm link'
                resultEl.innerHTML = `
                    <div class="error">
                        <h3>‚ùå L·ªói h·ªá th·ªëng</h3>
                        <p>Kh√¥ng th·ªÉ t√¨m ki·∫øm link: ${error.message}</p>
                        <p><a href="/">‚Üê V·ªÅ trang ch·ªß QLink4u</a></p>
                    </div>
                `
            }
        }
        
        // Start redirect process
        handleRedirect()
    </script>
</body>
</html>